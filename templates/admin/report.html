{{ template "layout" . }}
{{ define "content" }}
<section>
  <h1>Admin: Report {{ .Report.Domain }}</h1>
  <p><span class="badge badge-{{ .Report.Status }}">{{ .Report.Status }}</span></p>

  <section class="detail-section">
    <h2>URLs</h2>
    <ul>
      {{ range .Report.URLs }}
      <li><code>{{ . }}</code></li>
      {{ end }}
    </ul>
  </section>

  <section class="detail-section">
    <h2>Violation</h2>
    <dl>
      <dt>Type</dt>
      <dd>{{ .Report.ViolationType }}</dd>
      <dt>Description</dt>
      <dd>{{ .Report.Description }}</dd>
    </dl>
  </section>

  <section class="detail-section">
    <h2>Evidence</h2>
    <p class="content-warning">Evidence links may lead to disturbing content. Exercise caution when reviewing.</p>
    {{ if .Evidence }}
    <ul class="evidence-list">
      {{ range .Evidence }}
      <li class="evidence-item">
        {{ if .EvidenceURL }}
        <a href="{{ .EvidenceURL }}" target="_blank" rel="noopener noreferrer">{{ .EvidenceURL }}</a>
        {{ if .DriveVerified }}
        <span class="badge badge-verified" title="Verified via Google Drive API">Verified</span>
        <br><span class="evidence-meta">{{ .DriveFileName }} &middot; {{ .DriveMimeType }}{{ if .DriveSize }} &middot; {{ .DriveSize }} bytes{{ end }}</span>
        {{ else if .DriveFileID }}
        <span class="badge badge-unverified" title="Google Drive link not verified â€” user may not have granted Drive scope">Unverified</span>
        {{ end }}
        {{ if and .Description (not .DriveVerified) }}<span class="evidence-meta">{{ .Description }}</span>{{ end }}
        {{ else }}
        <span class="evidence-filename">{{ .Filename }}</span>
        <span class="evidence-meta">{{ .ContentType }} &middot; {{ .SizeBytes }} bytes &middot; SHA-256: <code class="hash">{{ .SHA256 }}</code></span>
        {{ end }}
      </li>
      {{ end }}
    </ul>
    {{ else }}
    <p>No evidence provided.</p>
    {{ end }}
  </section>

  {{ if .Emails }}
  <section class="detail-section">
    <h2>Outgoing Emails &amp; Replies</h2>
    {{ range .Emails }}
    <div class="email-entry" id="email-{{ .ID }}">
      <h3>
        {{ if eq (string .EmailType) "escalation" }}Escalation{{ else }}Initial Report{{ end }}
        to {{ .Recipient }} ({{ .RecipientOrg }})
      </h3>
      <dl>
        <dt>Status</dt>
        <dd><span class="badge badge-{{ .Status }}">{{ .Status }}</span></dd>
        <dt>Created</dt>
        <dd><time datetime="{{ .CreatedAt.Format "2006-01-02T15:04:05Z" }}">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</time></dd>
        {{ if .SentAt }}
        <dt>Sent</dt>
        <dd><time datetime="{{ .SentAt.Format "2006-01-02T15:04:05Z" }}">{{ .SentAt.Format "Jan 2, 2006 3:04 PM" }}</time></dd>
        {{ end }}
        {{ if .EscalateAfter }}
        <dt>Escalate After</dt>
        <dd><time datetime="{{ .EscalateAfter.Format "2006-01-02T15:04:05Z" }}">{{ .EscalateAfter.Format "Jan 2, 2006 3:04 PM" }}</time></dd>
        {{ end }}
        {{ if .ResponseNotes }}
        <dt>Response Notes</dt>
        <dd>{{ .ResponseNotes }}</dd>
        {{ end }}
      </dl>

      {{ $replies := index $.RepliesByEmail .ID }}
      {{ if $replies }}
      <div class="replies">
        <h4>Replies</h4>
        {{ range $replies }}
        <div class="reply-entry">
          <p class="reply-meta">
            From <strong>{{ .FromAddress }}</strong> on
            <time datetime="{{ .CreatedAt.Format "2006-01-02T15:04:05Z" }}">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</time>
          </p>
          <pre class="reply-body">{{ .Body }}</pre>
        </div>
        {{ end }}
      </div>
      {{ end }}

      {{ if eq (string .Status) "sent" }}
      <div class="reply-actions">
        <form method="post" action="/admin/emails/{{ .ID }}/reply-action" style="display:inline">
          <input type="hidden" name="csrf_token" value="{{ $.CSRFToken }}">
          <input type="hidden" name="action" value="resolve">
          <input type="text" name="notes" placeholder="Resolution notes..." style="width:300px">
          <button type="submit" class="btn btn-primary btn-sm"
            onclick="return confirm('Mark this case as resolved?')">Resolve</button>
        </form>
        <form method="post" action="/admin/emails/{{ .ID }}/reply-action" style="display:inline">
          <input type="hidden" name="csrf_token" value="{{ $.CSRFToken }}">
          <input type="hidden" name="action" value="escalate_now">
          <button type="submit" class="btn btn-danger btn-sm"
            onclick="return confirm('Immediately escalate to upstream providers?')">Escalate Now</button>
        </form>
        {{ if .ResponseNotes }}
        <form method="post" action="/admin/emails/{{ .ID }}/reply-action" style="display:inline">
          <input type="hidden" name="csrf_token" value="{{ $.CSRFToken }}">
          <input type="hidden" name="action" value="ignore_autoreply">
          <button type="submit" class="btn btn-secondary btn-sm"
            onclick="return confirm('Ignore auto-reply and resume escalation timer?')">Ignore Auto-Reply</button>
        </form>
        {{ end }}
      </div>
      {{ end }}
    </div>
    {{ end }}
  </section>
  {{ end }}

  {{ if eq (string .Report.Status) "cloudflare_pending" }}
  <section class="detail-section">
    <h2>Cloudflare Origin IP</h2>
    <p>This report is awaiting the origin IP from Cloudflare. Enter it below when received.</p>
    <form method="post" action="/admin/reports/{{ .Report.ID }}/origin-ip">
      <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
      <div class="form-group">
        <label for="origin_ip">Origin IP Address</label>
        <input type="text" id="origin_ip" name="origin_ip" required
          placeholder="203.0.113.1"
          pattern="[0-9a-fA-F.:]+">
      </div>
      <button type="submit" class="btn btn-primary">Save Origin IP</button>
    </form>
  </section>
  {{ end }}

  <section class="detail-section">
    <h2>Actions</h2>
    <div class="form-actions">
      <form method="post" action="/admin/reports/{{ .Report.ID }}/approve" style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
        <button type="submit" class="btn btn-primary"
          onclick="return confirm('Approve this report and queue emails for sending?')">Approve Report</button>
      </form>
      <form method="post" action="/admin/reports/{{ .Report.ID }}/reject" style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
        <div class="form-group">
          <label for="reject_notes">Rejection Notes</label>
          <textarea id="reject_notes" name="notes" rows="3" placeholder="Reason for rejection..."></textarea>
        </div>
        <button type="submit" class="btn btn-danger"
          onclick="return confirm('Reject this report?')">Reject Report</button>
      </form>
    </div>
  </section>

  <section class="detail-section">
    <h2>Send Email to User</h2>
    <form method="post" action="/admin/reports/{{ .Report.ID }}/send-email">
      <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
      <div class="form-group">
        <label for="subject">Subject</label>
        <input type="text" id="subject" name="subject" required>
      </div>
      <div class="form-group">
        <label for="message">Message</label>
        <textarea id="message" name="message" rows="5" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Send Email</button>
    </form>
  </section>

  {{ if .AuditLog }}
  <section class="detail-section">
    <h2>Audit Log</h2>
    <ol class="timeline">
      {{ range .AuditLog }}
      <li class="timeline-entry">
        <time datetime="{{ .CreatedAt.Format "2006-01-02T15:04:05Z" }}">{{ .CreatedAt.Format "Jan 2, 2006 3:04 PM" }}</time>
        <span class="timeline-action">{{ .Action }}</span>
        {{ if .Details }}<span class="timeline-details">{{ .Details }}</span>{{ end }}
      </li>
      {{ end }}
    </ol>
  </section>
  {{ end }}

  <div class="form-actions">
    <a href="/admin/queue" class="btn btn-secondary">Back to Queue</a>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.evidence-preview.blurred').forEach(function(el) {
      el.addEventListener('click', function() {
        this.classList.remove('blurred');
      });
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.classList.remove('blurred');
        }
      });
    });
  });
</script>
{{ end }}
